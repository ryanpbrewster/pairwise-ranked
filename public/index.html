<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Pairwise Ranking</title>
    <style>
    div {
      display: grid;
    }
    button {
      font-size: 14pt;
      margin: 10px;
    }
    </style>

    <script defer src="/__/firebase/7.0.0/firebase-app.js"></script>
    <script defer src="/__/firebase/7.0.0/firebase-database.js"></script>
    <script defer src="./index.js"></script>
    <script>
    document.addEventListener("DOMContentLoaded", () => {
    const DOM = {
      left: document.getElementById("left"),
      right: document.getElementById("right"),
    };
    let on_left_click = null;
    let on_right_click = null;
    DOM.left.addEventListener("click", evt => {
      on_left_click();
    });
    DOM.right.addEventListener("click", evt => {
      on_right_click();
    });
    const ORDERINGS = {};
    function mkkey(a, b) {
      return a < b ? `${a}###${b}` : mkkey(b, a);
    }
    function lt(a, b) {
      const max = ORDERINGS[mkkey(a, b)];
      if (max === undefined) return undefined;
      return max === b;
    }
    async function determine_ordering(a, b) {
      console.log(`which is bigger, ${a} or ${b}?`);
      DOM.left.textContent = a;
      DOM.right.textContent = b;
      return new Promise(r => {
        on_left_click = () => {
          ORDERINGS[mkkey(a, b)] = a;
          r();
        };
        on_right_click = () => {
          ORDERINGS[mkkey(a, b)] = b;
          r();
        };
      });
    }

    async function loop(inputs) {
      while (true) {
        const clone = [...inputs];
        const v = try_sort(clone, lt);
        if (!v) {
          break;
        }
        await determine_ordering(v[0], v[1]);
      }
    }

    const app = firebase.initializeApp({ databaseURL: "https://pairwise-ranked.firebaseio.com" });
    const listId = window.location.pathname === "/" ? "taylorswift" : window.location.pathname.slice(1);
    app.database().ref().child("lists").child(listId).once("value").then(async (snap) => {
      if (!snap.val()) {
        alert(`no such list: "${listId}"`);
        return;
      }


      const LIST = Object.values(snap.val());
      await loop(LIST);
      try_sort(LIST, lt);

      while (document.body.lastChild) {
        document.body.removeChild(document.body.lastChild);
      }
      const meta = document.createElement("p");
      meta.textContent = `${Object.keys(ORDERINGS).length} comparisons`;
      document.body.appendChild(meta);

      const ranked = document.createElement("ol");
      for (const elem of LIST) {
        const item = document.createElement("li");
        item.textContent = elem;
        ranked.appendChild(item);
      }
      document.body.appendChild(ranked);
    });
    });
    </script>
  </head>

  <body>
  <p>Which is better?</p>
  <button id="left">Left</button>
  <button id="right">Right</button>
  </body>
</html>
