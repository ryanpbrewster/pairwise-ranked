<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Pairwise Ranking</title>
    <style>
    body {
      display: grid;
      width: 500px;
      height: 300px;
    }
    #left {
      grid-row: 1;
      grid-column: 1;
    }
    #right {
      grid-row: 1;
      grid-column: 2;
    }
    button {
      background: #ffffff;
      border-radius: 15px;
      border: 4px solid #484848;
      color: #484848;
      min-height: 200px;
      width: 200px;
      padding: 20px;
      text-transform: uppercase;
    }
    button:active {
      color: #ffffff !important;
      background: #f6b93b;
      border-color: #f6b93b !important;
      transition: all 0.2s ease 0s;
      cursor: pointer;
    }
    button.pressed {
      color: #ffffff !important;
      background: #f6b93b;
      border-color: #f6b93b !important;
      transition: all 0.2s ease 0s;
    }
    </style>

    <script defer src="/__/firebase/7.0.0/firebase-app.js"></script>
    <script defer src="/__/firebase/7.0.0/firebase-database.js"></script>
    <script defer src="./index.js"></script>
    <script>
    document.addEventListener("DOMContentLoaded", () => {
    const DOM = {
      left: document.getElementById("left"),
      right: document.getElementById("right"),
    };
    let on_left_click = null;
    let on_right_click = null;
    let on_undo = null;
    DOM.left.addEventListener("click", evt => {
      on_left_click();
    });
    DOM.right.addEventListener("click", evt => {
      on_right_click();
    });
    document.body.addEventListener("keydown", evt => {
      switch (evt.keyCode) {
      case 37: // left
        DOM.left.classList.add("pressed");
        break;
      case 39: // right
        DOM.right.classList.add("pressed");
        break;
      case 90: // right
        on_undo();
        break;
      default:
      }
    });
    document.body.addEventListener("keyup", evt => {
      switch (evt.keyCode) {
      case 37: // left
        DOM.left.classList.remove("pressed");
        DOM.left.click();
        break;
      case 39: // right
        DOM.right.classList.remove("pressed");
        DOM.right.click();
        break;
      default:
      }
    });

    const LT_MAP = {};
    const ORD_HIST = [];
    function mkkey(a, b) {
      return `${a}###${b}`;
    }
    function lt(a, b) {
      return LT_MAP[mkkey(a, b)];
    }
    async function determine_ordering(a, b) {
      DOM.left.textContent = a;
      DOM.right.textContent = b;
      return new Promise(r => {
        on_left_click = () => {
          LT_MAP[mkkey(a, b)] = true;
          LT_MAP[mkkey(b, a)] = false;
          ORD_HIST.push([a, b]);
          r();
        };
        on_right_click = () => {
          LT_MAP[mkkey(a, b)] = false;
          LT_MAP[mkkey(b, a)] = true;
          ORD_HIST.push([a, b]);
          r();
        };
        on_undo = () => {
          const [a0, b0] = ORD_HIST.pop();
          delete LT_MAP[mkkey(a0, b0)];
          delete LT_MAP[mkkey(b0, a0)];
          r();
        };
      });
    }

    async function loop(inputs) {
      while (true) {
        const clone = [...inputs];
        const v = try_sort(clone, lt);
        if (!v) {
          break;
        }
        await determine_ordering(v[0], v[1]);
      }
    }

    const app = firebase.initializeApp({ databaseURL: "https://pairwise-ranked.firebaseio.com" });
    const listId = window.location.pathname === "/" ? "taylorswift" : window.location.pathname.slice(1);
    app.database().ref().child("lists").child(listId).once("value").then(async (snap) => {
      if (!snap.val()) {
        alert(`no such list: "${listId}"`);
        return;
      }


      const LIST = Object.values(snap.val());
      await loop(LIST);
      try_sort(LIST, lt);

      while (document.body.lastChild) {
        document.body.removeChild(document.body.lastChild);
      }
      const meta = document.createElement("p");
      meta.textContent = `${Object.keys(ORD_HIST).length} comparisons`;
      document.body.appendChild(meta);

      const ranked = document.createElement("ol");
      for (const elem of LIST) {
        const item = document.createElement("li");
        item.textContent = elem;
        ranked.appendChild(item);
      }
      document.body.appendChild(ranked);
    }).catch(err => {
      alert(`error w/ ${listId}: ${err}`)
    });
    });
    </script>
  </head>

  <body>
  <p>Which is better?</p>
  <button id="left">Left</button>
  <button id="right">Right</button>
  <!--
  <button id="hack">!!!</button>
  <script>
  document.getElementById("hack").addEventListener("click", () => setInterval(() => document.getElementById("left").click(), 10));
  </script>
  -->
  </body>
</html>
