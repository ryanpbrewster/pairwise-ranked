<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Pairwise Ranking</title>

    <script defer src="/__/firebase/7.0.0/firebase-app.js"></script>
    <script defer src="/__/firebase/7.0.0/firebase-auth.js"></script>
    <script defer src="/__/firebase/7.0.0/firebase-firestore.js"></script>
    <script defer src="/__/firebase/init.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
      location.hash = "signing_in";
      const app = firebase.app();
      app.auth().signInAnonymously().catch(function(error) {
        console.error(`failed to sign in: ${error.code} --- ${error.message}`);
        alert(`failed to sign in: ${error.code} --- ${error.message}`);
      });

      const LISTS = "lists";
      const ITEMS = "items";
      const INSTANCES = "instances";

      const db = app.firestore();
      function listRef(listId) {
        return db.collection(LISTS);
      }
      function instanceRef(listId, userId) {
        return db.collection(LISTS);
      }
      
      app.auth().onAuthStateChanged(function(user) {
        location.hash = user ? "lists" : "signing_in";
      });

      function mkNewListButton() {
      }

      function clearElement(e) {
        while (e.lastChild) {
          e.removeChild(e.lastChild);
        }
      }
      function viewSignedOut() {
        document.body.textContent = "signing in anonymously...";
      }
      function viewLists() {
        const holder = document.createElement("div");
        document.body.appendChild(holder);

        const persisted = document.createElement("div");
        holder.appendChild(persisted);

        const lists = db.collection(LISTS);

        const button = document.createElement("button");
        button.textContent = "New List";
        button.addEventListener("click", () => {
          const doc = lists.doc();
          doc.set({ owner: app.auth().currentUser.uid });
          window.localStorage.setItem('current_list', doc.id);
          location.hash = "edit_list";
        });
        holder.appendChild(button);

        lists.onSnapshot(snap => {
          clearElement(persisted);
          snap.docs.forEach(doc => {
            const item = document.createElement("p");
            item.textContent = doc.id;
            persisted.appendChild(item);
          });
        });
      }
      function viewListEditor() {
        const holder = document.createElement("div");
        document.body.appendChild(holder);

        const list_id = window.localStorage.getItem("current_list");
        if (!list_id) {
          console.error("could not find a list id");
          location.hash = "lists";
          return;
        }

        const list_title = document.createElement("p");
        list_title.textContent = list_id;
        list_title.style = "font-weight: bold";
        holder.appendChild(list_title);

        const persisted = document.createElement("div");
        holder.appendChild(persisted);

        const editor = document.createElement("textarea");
        holder.appendChild(editor);


        const items = db.collection(LISTS).doc(list_id).collection(ITEMS);
        items.orderBy("rank").onSnapshot(snap => {
          clearElement(persisted);
          snap.docs.forEach(doc => {
            const item = document.createElement("p");
            item.textContent = doc.data().text;
            persisted.appendChild(item);
          });
        });
        editor.addEventListener("keypress", evt => {
          if (evt.keyCode === 13) {
            evt.preventDefault();
            items.add({ text: editor.value, rank: Date.now() });
            editor.value = "";
          }
        });
      }

      window.addEventListener("hashchange", () => {
        clearElement(document.body);
        switch (location.hash) {
        case "#lists":
          return viewLists();

        case "#edit_list":
          return viewListEditor();

        case "#signing_in":
          return viewSignedOut();
        }
      });
    });
    </script>
  </head>

  <body>
  </body>
</html>
